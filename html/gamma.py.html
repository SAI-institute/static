<div id="gamma-app" style="text-align:center; font-family:sans-serif; margin:2em;">
  <div id="controls" style="margin-bottom:1em;">
    <label>α: <span id="alpha_val">2.00</span></label><br>
    <input id="alpha" type="range" min="0.2" max="10" value="2" step="0.01" style="width:80%;"><br><br>
    <label>β: <span id="beta_val">0.20</span></label><br>
    <input id="beta" type="range" min="0.1" max="5" value="0.2" step="0.01" style="width:80%;">
  </div>

  <div id="plot" style="max-width:600px;margin:auto;"></div>
 </div>

 <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>
 <script>
 // --- 純JS版 Plotly 描画 ---
 function gammaFunc(z){
   const g=7;
   const p=[
     0.99999999999980993,676.5203681218851,-1259.1392167224028,771.32342877765313,
     -176.61502916214059,12.507343278686905,-0.13857109526572012,
     9.9843695780195716e-6,1.5056327351493116e-7
   ];
   if(z<0.5) return Math.PI/(Math.sin(Math.PI*z)*gammaFunc(1-z));
   z-=1;
   let x=p[0];
   for(let i=1;i<g+2;i++) x+=p[i]/(z+i);
   const t=z+g+0.5;
   return Math.sqrt(2*Math.PI)*Math.pow(t,z+0.5)*Math.exp(-t)*x;
 }

 function gammaPDF(x, alpha, beta){
   if(x<=0) return 0;
   return Math.pow(x,alpha-1)*Math.exp(-x/beta)/(Math.pow(beta,alpha)*gammaFunc(alpha));
 }

 function plotGamma(){
  const alpha=parseFloat(document.getElementById('alpha').value);
  const beta =parseFloat(document.getElementById('beta').value);
  const delta=0.003;
  const xAxisStart=0;            // グリッド/y軸用の開始
  const xPlotStart=0.0000000001;         // プロット用の開始（0未満を描かない）
  const xAll=Array.from({length:Math.floor((2-xAxisStart)/delta)+1},(_,i)=>xAxisStart+i*delta);
  const x=xAll.filter(v=>v>=xPlotStart);
  const y=x.map(v=>Math.min(gammaPDF(v,alpha,beta),2));
  const yRef=x.map(v=>Math.min(gammaPDF(v,1,beta),2));

  // レスポンシブ: 幅に応じて高さ/凡例配置を調整
  const plotEl=document.getElementById('plot');
  const w=plotEl.clientWidth||600;
  const isNarrow=w<500;
  const height=isNarrow?Math.max(260,Math.round(w*0.7)):400;
  const legendCfg=isNarrow
    ? {orientation:'h', x:0.5, xanchor:'center', y:-0.2, yanchor:'top'}
    : {orientation:'h', x:0.5, xanchor:'center', y:-0.15, yanchor:'top'};
  const marginCfg=isNarrow?{t:30,r:20,b:60,l:45}:{t:40,r:20,b:50,l:60};

  const layout={
    xaxis:{range:[xAxisStart,2],title:'x',showgrid:true,zeroline:true,showline:true,linecolor:'#333'},
    yaxis:{range:[0,2],title:'Density',showgrid:true,zeroline:true,showline:true,linecolor:'#333'},
    margin:marginCfg,
    legend:legendCfg,
    height:height
  };

  // 初回のみ newPlot。以降は restyle/relayout で更新。
  if(!window._gammaInited){
    const traceRef={x,y:yRef,mode:'lines',line:{color:'gray',dash:'dot',width:2},opacity:0.3,name:'α=1 reference'};
    const traceMain={x,y,mode:'lines',line:{color:'royalblue',width:2},name:'Gamma PDF'};
    const traceMode={x:[],y:[],mode:'markers',marker:{color:'red',size:8},name:'Mode',visible:false};
    Plotly.newPlot('plot',[traceRef,traceMain,traceMode],layout,{responsive:true});
    window._gammaInited=true;
  } else {
    Plotly.restyle('plot', {x:[x], y:[yRef]}, [0]);
    Plotly.restyle('plot', {x:[x], y:[y]}, [1]);
  }

  if(alpha>=1){
    const modeX=(alpha-1)*beta;
    const modeY=Math.min(gammaPDF(modeX,alpha,beta),2);
    if(modeX>=xPlotStart){
      Plotly.restyle('plot', {x:[[modeX]], y:[[modeY]], visible:true}, [2]);
    } else {
      Plotly.restyle('plot', {visible:false}, [2]);
    }
  } else {
    Plotly.restyle('plot', {visible:false}, [2]);
  }

  Plotly.relayout('plot', {
    'xaxis.range':[xAxisStart,2],
    height:height,
    legend:legendCfg,
    margin:marginCfg
  });
 }

 function updatePlot(){
   document.getElementById('alpha_val').textContent=parseFloat(document.getElementById('alpha').value).toFixed(2);
   document.getElementById('beta_val').textContent =parseFloat(document.getElementById('beta').value).toFixed(2);
   plotGamma();
 }

 document.getElementById('alpha').addEventListener('input',updatePlot);
 document.getElementById('beta').addEventListener('input',updatePlot);
 // 画面幅変更時にもレイアウト最適化（debounce）
 let _gammaResizeTimer=null;
 window.addEventListener('resize', ()=>{
   clearTimeout(_gammaResizeTimer);
   _gammaResizeTimer=setTimeout(()=>{
     plotGamma();
   },150);
 });
 updatePlot();
 </script>
